---

# Build script templates ------------------------

.setup-makisu-build-vars-template: &setup-makisu-build-vars |
  DOCKERFILE_FILENAME="${DOCKERFILE##*/}" && \
  TAG="${DOCKERFILE_FILENAME}${TAG_SUFFIX}" && \
  CI_IMAGE="${CI_REGISTRY_IMAGE}:${TAG}" && \
  REPLICA_TAG="${DOCKERFILE_FILENAME}${REPLICA_TAG_SUFFIX}" && \
  CI_IMAGE_ALT="${CI_REGISTRY_IMAGE}:${REPLICA_TAG}";

.log-makisu-build-vars-template: &log-makisu-build-vars |
  echo "Image tags for Dockerfile \`${DOCKERFILE_FILENAME}\`" && \
  echo "TAG=\`${TAG}\`" && \
  echo "REPLICA_TAG=\`${REPLICA_TAG}"\`;

.makisu-build-image-template: &makisu-build-image |
  /makisu-internal/makisu \
  --log-level=debug \
  --log-fmt=console \
  build \
  --replica="${CI_REGISTRY}/${CI_IMAGE_ALT}" \
  --push=$CI_REGISTRY \
  --modifyfs \
  --preserve-root \
  -t="${CI_IMAGE}" \
  --registry-config="${REGISTRY_CONFIG_FILE}" \
  -f="${DOCKERFILE}" \
  --build-arg=DOCKER_TAG="${TAG}" \
  --commit=implicit \
  --storage=/makisu-storage \
  --redis-cache-addr=redis-svc:6379  \
  "${CONTEXT}";

# Build job base template ------------------------

.makisu-builder-base:
  image:
    # yamllint disable-line rule:line-length
    name: gcr.io/uber-container-tools/makisu-alpine:v0.4.1@sha256:0fc8ba49b6a219e68009eac4e9ca4d4120b04cf3b18eb9d499bda0beb387a65d
    entrypoint: [""]
  variables:
    CI_REGISTRY: "index.docker.io"
    REGISTRY_CONFIG: |
      {
        "${CI_REGISTRY}": {
          ".*": {
            "concurrency": 64,
            "push_chunk": -1,
            "security": {
              "tls": {
                "client": {
                  "disabled": false
                }
              },
              "basic": {
                "username": "${DOCKER_NAMESPACE}",
                "password": "${DOCKER_PASSWORD}"
              }
            }
          }
        }
      }
    REGISTRY_CONFIG_FILE: "${CI_PROJECT_DIR}/registry-config.yml"
    CURL_CA_BUNDLE: "/makisu-internal/certs/cacerts.pem"
  before_script:
    - |
      echo "http://dl-4.alpinelinux.org/alpine/edge/community" \
      >> /etc/apk/repositories
    - apk update
    - apk add yq --no-cache
    - apk add jq
    - |
      echo "${REGISTRY_CONFIG}" \
      | yq read - --prettyPrint > "${REGISTRY_CONFIG_FILE}"

# Build job multi-image template ------------------------

.makisu-builder-multi:
  extends:
    - .makisu-builder-base
  script:
    - apk add coreutils # For updated `sort` binary
    - for DOCKERFILE in $(ls -d "${CONTEXT}"/* | sort -V); do
    - *setup-makisu-build-vars
    - *log-makisu-build-vars
    - *makisu-build-image
    - done

# Build job ------------------------

build-and-push:docker-image-multi:
  stage: Build & Push
  extends:
    - .makisu-builder-multi
    - .retry
  variables:
    CONTEXT: "${CI_PROJECT_DIR}/Dockerfiles"
